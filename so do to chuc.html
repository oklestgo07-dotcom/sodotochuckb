<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Sơ đồ nhân sự</title>
    <script src="https://unpkg.com/gojs/release/go.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        /* === GIAO DIỆN CHUNG === */
        body { 
            margin: 0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            background-color: #f0f2f5; 
        }
        #toolbar { 
            padding: 8px 15px; 
            background: #ffffff; 
            border-bottom: 1px solid #e0e0e0; 
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            display: flex; 
            gap: 10px; 
            align-items: center;
        } 
        #main { flex: 1; display: flex; }
        #chart { flex: 1; background-color: #f0f2f5; }

        /* === INFO PANEL === */
        #info { 
            width: 320px; 
            background: #ffffff; 
            border-right: 2px solid #e0e0e0; 
            padding: 20px; 
            overflow-y: auto; 
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }
        .title { 
            font-weight: 600; 
            font-size: 20px; 
            margin-bottom: 15px; 
            color: #1877f2; 
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 5px;
        }
        #detail {
            font-size: 16px;
            line-height: 1.6;
            color: #333;
        }
        #detail b {
            color: #555;
            font-weight: 500;
        }

        /* === TOOLBAR BUTTONS === */
        button.icon-btn { 
            background: none; 
            border: none; 
            cursor: pointer; 
            font-size: 20px; 
            padding: 8px; 
            border-radius: 8px; 
            color: #555;
            transition: all 0.2s;
        }
        button.icon-btn:hover { 
            color: #1877f2; 
            background: rgba(24, 119, 242, 0.1); 
        }
    </style>
</head>
<body>
    <div id="toolbar">
        <button onclick="resetDiagram()" title="Reset/Phóng to vừa khung" class="icon-btn"> 
            <i class="fas fa-sitemap"></i>
        </button>
    </div>

    <div id="main">
        <div id="info">
            <div class="title">Chi tiết Nhân sự</div>
            <div id="detail">Bấm vào nhân sự để xem chi tiết</div>
        </div>
        <div id="chart"></div>
    </div>

    <script>
        let myDiagram;
        let selectedNode = null; 

        // Hàm viết tắt chức vụ (Không viết tắt Giao dịch viên)
        function abbrevRole(role) {
            if (!role) return "";
            
            if (role === "Giao dịch viên") {
                return role; 
            }
            
            return role
                .replace("Trưởng phòng", "Trưởng phòng")
                .replace("Phó Trưởng phòng", "Phó Trưởng phòng")
                .replace("Kế toán trưởng", "Kế toán trưởng")
                .replace("Ủy quyền Kế toán trưởng", "UQ. KTT");
        }

        // Hàm tạo text hiển thị trên Node
        function createNodeText(d) {
            // Đối với Node không có tên (Nhóm GDV, Tầng)
            if (!d.name && d.short) {
                return d.short;
            }
            
            // Đối với Node nhân sự: Tên (Chức vụ viết tắt)
            const roleAbbrev = abbrevRole(d.role);
            
            if (d.name) {
                // Yêu cầu: Tên đầy đủ phía trên, Chức vụ viết tắt phía dưới
                return d.name + (roleAbbrev ? "\n(" + roleAbbrev + ")" : "");
            }
            
            return d.short || ""; 
        }

        // Hàm tạo node template mới
        function createNodeTemplate() {
            const $ = go.GraphObject.make;

            return $(go.Node, "Auto", // Đổi lại thành Auto vì không cần Spot
                { 
                    isTreeExpanded: false,
                    selectionAdornmentTemplate:
                        $(go.Adornment, "Auto",
                            $(go.Shape, "RoundedRectangle", { fill: null, stroke: "#1877f2", strokeWidth: 3 }),
                            $(go.Placeholder)
                        ),
                    shadowColor: "#aaaaaa", 
                    shadowOffset: new go.Point(2, 2)
                },
                // Vùng chính (Rectangle)
                $(go.Shape, "RoundedRectangle",
                    new go.Binding("fill", "color"), 
                    { 
                        stroke: "#ddd", 
                        strokeWidth: 1,
                        minSize: new go.Size(180, 50) 
                    }
                ),
                // Nội dung (TextBlock)
                $(go.TextBlock,
                    {
                        margin: 10, // Margin đều để căn giữa (đã bỏ Avatar)
                        stroke: "white",
                        font: "500 13px Segoe UI, sans-serif",
                        wrap: go.TextBlock.WrapFit,
                        textAlign: "center"
                    },
                    new go.Binding("text", "", createNodeText)
                )
            );
        }


        // ==== Các hàm lưu / tải / init (Giữ nguyên logic data) ====

        function loadFromLocal() {
            const saved = localStorage.getItem("orgChartModel");
            if (saved) {
                try {
                    myDiagram.model = go.Model.fromJson(saved);
                    return true;
                } catch (e) {
                    console.error("Lỗi khi tải dữ liệu từ localStorage:", e);
                    localStorage.removeItem("orgChartModel");
                    return false;
                }
            }
            return false;
        }

        function init() {
            const $ = go.GraphObject.make;

            myDiagram = $(go.Diagram, "chart", {
                layout: $(go.LayeredDigraphLayout, { direction: 90, layerSpacing: 50, columnSpacing: 30 }),
                "toolManager.mouseWheelBehavior": go.ToolManager.WheelZoom,
                allowZoom: true,
                allowMove: false, 
                allowCopy: false, 
                allowDelete: false, 
                allowInsert: false,
                initialAutoScale: go.Diagram.Uniform, 
                padding: 10
            });

            // Gán template Node đã chỉnh sửa
            myDiagram.nodeTemplate = createNodeTemplate();

            // Nếu không có dữ liệu lưu thì dùng dữ liệu gốc
            if (!loadFromLocal()) {
                
                // ==== DỮ LIỆU GỐC (Giữ nguyên) ====
                const dataColors = {
                    manager: "#2a8bdc",      
                    deputy: "#4caf50",       
                    chiefAcc: "#e91e63",     
                    authAcc: "#ff9800",      
                    gdv: "#03a9f4",          
                    group: "#673ab7",        
                    floor: "#9c27b0"         
                };

                nodeData = [
                    { key: 1, name: "Trần Thị Tuyết Mai", role: "Trưởng phòng", phone: "091.859.7568", seat: "Tầng 5", color: dataColors.manager },
                    { key: 2, name: "Đinh Bá Tòng", role: "Phó Trưởng phòng", phone: "094.431.0999", seat: "Tầng 4", color: dataColors.deputy },
                    { key: 3, name: "Nguyễn Minh Tuấn", role: "Phó Trưởng phòng", phone: "090.902.4682", seat: "Tầng 5", color: dataColors.deputy },
                    { key: 4, name: "Nguyễn Thị Thanh Hường", role: "Phó Trưởng phòng", phone: "098.317.1016", seat: "Tầng 2", color: dataColors.deputy },
                    { key: 5, name: "Nguyễn Thị Ngọc Lan", role: "Kế toán trưởng", phone: "091.855.1655", seat: "Tầng 2", color: dataColors.chiefAcc },
                    { key: 6, name: "Nguyễn Vân Anh", role: "Ủy quyền Kế toán trưởng", phone: "078.658.2268", seat: "Tầng 1", color: dataColors.authAcc },
                    { key: 7, name: "Dương Thị Tuyết Trinh", role: "Ủy quyền Kế toán trưởng", phone: "097.661.0090", seat: "Tầng 3", color: dataColors.authAcc },
                    { key: 8, name: "Trần Thị Như Ngọc", role: "Ủy quyền Kế toán trưởng", phone: "090.717.0189", seat: "Tầng 3", color: dataColors.authAcc },
                    { key: 9, name: "Hoàng Thị Ngọc Lan", role: "Ủy quyền Kế toán trưởng", phone: "081.368.9368", seat: "Tầng 3", color: dataColors.authAcc },
                    { key: 10, name: "Nguyễn Thị Thanh Thảo", role: "Ủy quyền Kế toán trưởng", phone: "094.428.0844", seat: "Tầng 4", color: dataColors.authAcc },
                    { key: 11, name: "Lê Thị Thúy Hằng", role: "Ủy quyền Kế toán trưởng", phone: "098.928.0357", seat: "Tầng 4", color: dataColors.authAcc },
                    { key: 12, name: "Nguyễn Thị Thúy Mẫn", role: "Ủy quyền Kế toán trưởng", phone: "098.928.0357", seat: "Tầng 5", color: dataColors.authAcc },
                    
                    { key: 100, short: "Giao dịch viên", role: "Nhóm Giao dịch viên", isGroupNode: true, color: dataColors.group },
                    { key: 20, short: "Tầng 1", isFloor: true, color: dataColors.floor },
                    { key: 30, short: "Tầng 2", isFloor: true, color: dataColors.floor },
                    { key: 40, short: "Tầng 3", isFloor: true, color: dataColors.floor },
                    { key: 50, short: "Tầng 4", isFloor: true, color: dataColors.floor },
                    { key: 60, short: "Tầng 5", isFloor: true, color: dataColors.floor }
                ];
                
                let nextKey = 1000;
                const gdvList = [
                    // Tầng 1 (key 20)
                    { name: "Nguyễn Ngọc Anh", phone: "096.982.5676", seat: "Tầng 1", parent: 20 },
                    { name: "Phạm Cao Sơn", phone: "090.890.8405", seat: "Tầng 1", parent: 20 },
                    { name: "Dương Thị Quý Mai", phone: "070.633.1049", seat: "Tầng 1", parent: 20 },
                    { name: "Đỗ Ngọc Khánh", phone: "090.729.9449", seat: "Tầng 1", parent: 20 },
                    { name: "Trần Thị Nguyệt", phone: "077.445.8098", seat: "Tầng 1", parent: 20 },
                    { name: "Nguyễn Hải Kim Thảo", phone: "077.667.3667", seat: "Tầng 1", parent: 20 },
                    
                    // Tầng 2 (key 30)
                    { name: "Lê Nguyễn Thanh Thúy", phone: "092.252.6672", seat: "Tầng 2", parent: 30 },
                    { name: "Nguyễn Hân", phone: "091.881.7681", seat: "Tầng 2", parent: 30 },
                    { name: "Nguyễn Thị Thùy Linh", phone: "093.655.7559", seat: "Tầng 2", parent: 30 },
                    { name: "Hoàng Văn Thình", phone: "093.563.4478", seat: "Tầng 2", parent: 30 },
                    { name: "Nguyễn Thị Thủy", phone: "090.834.7954", seat: "Tầng 2", parent: 30 },
                    { name: "Nguyễn Quế Lâm", phone: "036.907.6932", seat: "Tầng 2", parent: 30 },
                    { name: "Nguyễn Thị Trúc Uyên", phone: "090.731.3090", seat: "Tầng 2", parent: 30 },
                    
                    // Tầng 3 (key 40)
                    { name: "Thới Mỹ Hạnh", phone: "098.445.5773", seat: "Tầng 3", parent: 40 },
                    { name: "Đinh Thị Vân Thi", phone: "098.959.8905", seat: "Tầng 3", parent: 40 },
                    { name: "Trương Thị Hồng Ý", phone: "093.536.5563", seat: "Tầng 3", parent: 40 },
                    { name: "Nguyễn Thị Thúy Ni", phone: "034.968.2095", seat: "Tầng 3", parent: 40 },
                    { name: "Đoàn Thị Út Thu", phone: "090.822.4547", seat: "Tầng 3", parent: 40 },
                    { name: "Phan Thị Thanh Thảo", phone: "090.472.6693", seat: "Tầng 3", parent: 40 },
                    { name: "Nguyễn Thị Hiền", phone: "090.331.5478", seat: "Tầng 3", parent: 40 },
                    { name: "Trần Thị Ngọc Mai", phone: "078.228.3293", seat: "Tầng 3", parent: 40 },
                    { name: "Phạm Thị Hồng Điệp", phone: "090.244.9479", seat: "Tầng 3", parent: 40 },
                    { name: "Nguyễn Phụng Kiều Tiên", phone: "090.919.7333", seat: "Tầng 3", parent: 40 },

                    // Tầng 4 (key 50)
                    { name: "Nguyễn Minh Chi", phone: "093.127.9276", seat: "Tầng 4", parent: 50 },
                    { name: "Lê Thị Hương Thu", phone: "093.176.8203", seat: "Tầng 4", parent: 50 },
                    { name: "Nguyễn Ngọc Quỳnh Hương", phone: "093.204.2725", seat: "Tầng 4", parent: 50 },
                    { name: "Lữ Thị Hồng", phone: "090.662.0026", seat: "Tầng 4", parent: 50 },
                    { name: "Hoàng Thị Nhung", phone: "097.389.1089", seat: "Tầng 4", parent: 50 },
                    { name: "Nguyễn Ngọc Hoài", phone: "093.708.8145", seat: "Tầng 4", parent: 50 },
                    { name: "Trần Hoàng Phú", phone: "093.857.9836", seat: "Tầng 4", parent: 50 },
                    { name: "Nguyễn Thị Hồng Phượng", phone: "033.245.8858", seat: "Tầng 4", parent: 50 },
                    { name: "Nguyễn Thị Ngọc", phone: "097.537.9135", seat: "Tầng 4", parent: 50 },
                    
                    // Tầng 5 (key 60)
                    { name: "Hồ Minh Duy", phone: "083.499.0690", seat: "Tầng 5", parent: 60 },
                    { name: "Mai Vũ Minh Hà", phone: "034.686.9638", seat: "Tầng 5", parent: 60 },
                    { name: "Lê Thị Thu Hương", phone: "090.587.1467", seat: "Tầng 5", parent: 60 }
                ];
                
                // Thêm GDV vào nodeData
                gdvList.forEach(d => {
                    nodeData.push({ 
                        key: nextKey++, 
                        name: d.name, 
                        role: "Giao dịch viên", 
                        phone: d.phone, 
                        seat: d.seat, 
                        isGDV: true, 
                        color: dataColors.gdv,
                        parentRef: d.parent 
                    });
                });

                // --- Liên kết (Link Data) ---
                linkData = [
                    { from: 1, to: 2 }, { from: 1, to: 3 }, { from: 1, to: 4 },
                    { from: 2, to: 5 }, { from: 3, to: 5 }, { from: 4, to: 5 },
                    { from: 5, to: 6 }, { from: 5, to: 7 }, { from: 5, to: 8 }, { from: 5, to: 9 },
                    { from: 5, to: 10 }, { from: 5, to: 11 }, { from: 5, to: 12 },
                    { from: 6, to: 100 }, { from: 7, to: 100 }, { from: 8, to: 100 },
                    { from: 9, to: 100 }, { from: 10, to: 100 }, { from: 11, to: 100 }, { from: 12, to: 100 },
                    { from: 100, to: 20 }, { from: 100, to: 30 }, { from: 100, to: 40 }, { from: 100, to: 50 }, { from: 100, to: 60 }
                ];
                
                for (let n of nodeData) {
                    if (n.isGDV) {
                        linkData.push({ from: n.parentRef, to: n.key });
                    }
                }

                myDiagram.model = new go.GraphLinksModel(nodeData, linkData);
            } 

            // Sự kiện click node
            myDiagram.addDiagramListener("ObjectSingleClicked", e => {
                const part = e.subject.part;
                if (!(part instanceof go.Node)) return;
                const d = part.data;
                selectedNode = d;

                // Mở/đóng Tầng
                if (d.isFloor || d.isGroupNode) {
                    myDiagram.startTransaction("toggleExpand");
                    part.isTreeExpanded = !part.isTreeExpanded;
                    myDiagram.commitTransaction("toggleExpand");
                }

                // Hiển thị chi tiết
                let html = "";
                if (d.name) {
                    html += `<b>Họ & tên:</b> ${d.name}<br>`;
                } else if (d.short) {
                    html += `<b>Label:</b> ${escapeHtml(d.short).replace(/\n/g, "<br>")}<br>`;
                } else {
                    html += `<b>Tên:</b> -<br>`;
                }

                if (d.role) html += `<b>Chức vụ:</b> ${d.role}<br>`;
                if (d.phone) html += `<b>Số điện thoại:</b> ${d.phone}<br>`;
                if (d.seat) html += `<b>Vị trí ngồi:</b> ${d.seat}<br>`;

                document.getElementById("detail").innerHTML = html;

                // Zoom to Node
                myDiagram.startTransaction("zoomToNode");
                const nodeBounds = part.actualBounds.copy().inflate(50, 50); 
                const vb = myDiagram.viewportBounds;
                const scaleX = vb.width / nodeBounds.width;
                const scaleY = vb.height / nodeBounds.height;
                let newScale = Math.min(scaleX, scaleY);
                newScale = Math.min(newScale, 2); 
                myDiagram.scale = newScale;
                myDiagram.centerRect(nodeBounds);
                myDiagram.commitTransaction("zoomToNode");
            });

            resetDiagram();
        }

        function resetDiagram() {
            myDiagram.startTransaction("reset");
            myDiagram.nodes.each(n => {
                if (n.data.key <= 12 || n.data.key === 100) {
                    n.isTreeExpanded = true;
                } else {
                    n.isTreeExpanded = false; 
                }
            });
            myDiagram.zoomToFit(); 
            myDiagram.commitTransaction("reset");
        }


        function escapeHtml(unsafe) {
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>